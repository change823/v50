# 删除策略更新说明

## 📝 问题描述

之前的 RLS 策略只允许删除 `pending` 状态的记录，导致删除 `active` 或 `rejected` 状态的记录时虽然提示成功，但实际未删除。

## ✅ 解决方案

### 已完成的修改

#### 1. 数据库 RLS 策略（需要手动执行）

**文件**: `scripts/update-delete-policy.sql`

**修改内容**:
- 删除旧策略：`authenticated_delete_pending`（只能删除 pending）
- 创建新策略：`authenticated_delete_all`（可以删除任何状态）

#### 2. 前端代码（已自动更新）

**文件**: `src/components/AdminPanel.vue`

**修改内容**:
- ✅ 移除了状态检查限制
- ✅ 添加了根据状态显示不同的警告提示
- ✅ 对 `active` 状态的文案给予特别警告
- ✅ 改进了错误处理

---

## 🚀 执行步骤

### 步骤 1：更新数据库策略

1. 打开 Supabase Dashboard
2. 进入 **SQL Editor**
3. 打开 `scripts/update-delete-policy.sql` 文件
4. 复制全部内容
5. 粘贴到 SQL Editor 并执行

### 步骤 2：验证更新

执行后应该看到：

```
策略名称                    | 操作类型 | 应用角色        | USING条件
----------------------------|----------|----------------|----------
authenticated_delete_all    | DELETE   | {authenticated}| true
```

### 步骤 3：测试删除功能

1. 刷新管理后台页面（http://localhost:5174/admin）
2. 尝试删除不同状态的文案：
   - **pending**：会提示"确定要删除这条【待审核】文案吗？"
   - **active**：会弹出警告"⚠️ 警告：这是一条【已激活】的文案，正在首页展示中！"
   - **rejected**：会提示"确定要删除这条【已拒绝】文案吗？"
3. 确认后，数据应该被真正删除

---

## 🎯 新的删除行为

### 删除提示

根据文案状态，会显示不同的确认提示：

| 状态      | 提示内容                                                     |
|-----------|-------------------------------------------------------------|
| pending   | 确定要删除这条【待审核】文案吗？                             |
| active    | ⚠️ 警告：这是一条【已激活】的文案，正在首页展示中！删除后用户将无法看到这条文案。确定要删除吗？ |
| rejected  | 确定要删除这条【已拒绝】文案吗？                             |

### 权限说明

- ✅ 已登录的管理员可以删除**任何状态**的文案
- ❌ 未登录用户无法删除任何文案
- ⚠️ 删除 `active` 状态的文案会有额外警告提示

---

## ⚠️ 注意事项

### 1. 数据安全

- **删除操作不可恢复**
- 删除前请确认文案内容
- 建议定期备份数据库

### 2. 对 active 文案的特别警告

删除已激活的文案意味着：
- 该文案将从首页消失
- 用户无法再抽取到这条文案
- 操作立即生效且不可撤销

### 3. 建议的删除策略

**推荐删除**：
- 重复的文案
- 质量差的待审核文案
- 违规内容

**谨慎删除**：
- 已激活且受欢迎的文案
- 有争议但合规的内容

**建议保留**：
- 高质量的已激活文案
- 有历史价值的内容

---

## 🔄 如果想恢复旧策略

如果您想恢复只能删除 `pending` 的限制，执行：

```sql
-- 删除新策略
DROP POLICY IF EXISTS "authenticated_delete_all" ON copywriting;

-- 恢复旧策略
CREATE POLICY "authenticated_delete_pending"
ON copywriting FOR DELETE
TO authenticated
USING (status = 'pending');
```

同时需要在前端代码中恢复状态检查。

---

## 💡 高级选项：软删除

如果您担心误删重要数据，建议使用软删除方案：

参考文档：`scripts/optimize-rls-policies-with-soft-delete.sql`

软删除的优点：
- ✅ 数据可恢复
- ✅ 保留删除记录用于审计
- ✅ 可以设置自动清理策略

---

## 📊 总结

| 项目       | 修改前                    | 修改后                      |
|------------|---------------------------|----------------------------|
| 可删除状态 | 仅 pending                | 所有状态（pending/active/rejected） |
| 删除提示   | 统一提示                   | 根据状态显示不同提示        |
| 安全警告   | 无                         | active 状态有额外警告       |
| 错误处理   | 基础                       | 改进的错误提示              |

---

## ✅ 完成检查清单

更新完成后，请验证：

- [ ] 执行了 `update-delete-policy.sql` 脚本
- [ ] 前端代码已自动更新（AdminPanel.vue）
- [ ] 刷新了管理后台页面
- [ ] 测试删除 pending 状态文案 ✓
- [ ] 测试删除 active 状态文案 ✓  
- [ ] 测试删除 rejected 状态文案 ✓
- [ ] 确认删除后数据真的被移除 ✓

---

**更新时间**: 2026-02-02
**影响范围**: RLS 删除策略 + 前端删除逻辑
**向后兼容**: 是（只是扩展了权限）
